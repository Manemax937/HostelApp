rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin or owner
    function isAdminOrOwner() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'owner'];
    }
    
    // Helper function to check if user is the document owner
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read users (needed for residence verification)
      allow read: if isSignedIn();
      
      // Users can create their own account during registration
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Users can update their own profile, admins/owners can update any
      allow update: if isOwner(userId) || isAdminOrOwner();
      
      // Only admins/owners can delete
      allow delete: if isAdminOrOwner();
    }
    
    // Payments collection
    match /payments/{paymentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdminOrOwner();
      allow delete: if isAdminOrOwner();
    }
    
    // Complaints collection
    match /complaints/{complaintId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdminOrOwner();
      allow delete: if isAdminOrOwner();
    }
    
    // Washing machines collection (legacy)
    match /washing_machines/{machineId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdminOrOwner();
    }
    
    // Machines collection
    match /machines/{machineId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrOwner();
      allow update: if isSignedIn();
      allow delete: if isAdminOrOwner();
    }
    
    // PG Attendance collection
    match /pg_attendance/{attendanceId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdminOrOwner();
    }
    
    // PG Locations collection
    match /pg_locations/{locationId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrOwner();
      allow update: if isAdminOrOwner();
      allow delete: if isAdminOrOwner();
    }
    
    // Housekeeping collection
    match /housekeeping/{recordId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdminOrOwner();
    }
    
    // Housekeeping Logs collection (for staff check-in/check-out)
    match /housekeeping_logs/{logId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdminOrOwner();
    }
    
    // Notices collection
    match /notices/{noticeId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrOwner();
      allow update: if isAdminOrOwner();
      allow delete: if isAdminOrOwner();
    }
    
    // Rent Dues collection
    match /rentDues/{rentDueId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrOwner();
      allow update: if isSignedIn(); // Students can update to link payment
      allow delete: if isAdminOrOwner();
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Users can mark as read
      allow delete: if isAdminOrOwner();
    }

    // App Config collection (for floor configuration etc.)
    match /app_config/{configId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrOwner();
      allow update: if isAdminOrOwner();
      allow delete: if isAdminOrOwner();
    }

    // Banners collection (for advertisement carousel)
    match /banners/{bannerId} {
      allow read: if isSignedIn();
      allow create: if isAdminOrOwner();
      allow update: if isAdminOrOwner();
      allow delete: if isAdminOrOwner();
    }
  }
}
